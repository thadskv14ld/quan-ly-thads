<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HỆ THỐNG ĐỒNG BỘ REALTIME</title>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #e2e8f0; }
        
        /* HEADER MỚI */
        #header { height: 45px; background: #0f172a; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; border-bottom: 2px solid #334155; }
        
        .tabs { display: flex; gap: 5px; height: 100%; }
        .tab { background: transparent; border: none; color: #94a3b8; padding: 0 15px; font-weight: 600; cursor: pointer; height: 100%; font-size: 13px; transition: 0.2s; border-bottom: 3px solid transparent; }
        .tab:hover { color: #e2e8f0; background: rgba(255,255,255,0.05); }
        .tab.active { color: #38bdf8; border-bottom: 3px solid #38bdf8; }

        /* ĐÈN TRẠNG THÁI */
        .status-area { display: flex; align-items: center; gap: 10px; font-size: 12px; background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 20px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        
        .dot.sync { background: #eab308; animation: pulse 1s infinite; } /* Vàng: Đang xử lý */
        .dot.ok { background: #22c55e; box-shadow: 0 0 8px #22c55e; }   /* Xanh: Đã lưu/Đã tải */
        .dot.err { background: #ef4444; } /* Đỏ: Lỗi */

        #status-text { min-width: 80px; text-align: left; font-weight: 500;}

        /* IFRAME */
        #container { flex: 1; position: relative; background: white; }
        iframe { width: 100%; height: 100%; border: none; position: absolute; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        iframe.active { visibility: visible; opacity: 1; z-index: 10; }

        /* MÀN HÌNH CHỜ (LOADING) */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: opacity 0.5s;}
        .spinner { width: 40px; height: 40px; border: 4px solid #1e293b; border-top: 4px solid #38bdf8; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>Đang đồng bộ dữ liệu...</p>
    </div>

    <div id="header">
        <div class="tabs">
            <button class="tab active" onclick="sw(0)">QUẢN LÝ BIÊN LAI</button>
            <button class="tab" onclick="sw(1)">GỬI BƯU ĐIỆN</button>
            <button class="tab" onclick="sw(2)">ĐỀ NGHỊ CHI</button>
        </div>
        <div class="status-area">
            <span id="dot" class="dot sync"></span>
            <span id="status-text">Đang tải...</span>
        </div>
    </div>

    <div id="container">
        <iframe id="f0" src="bien-lai.html" class="active"></iframe>
        <iframe id="f1" src="buu-dien.html"></iframe>
        <iframe id="f2" src="de-nghi-chi.html"></iframe>
    </div>

    <script>
        // ================================================================
        // DÁN LINK GOOGLE APPS SCRIPT CỦA BẠN VÀO ĐÂY:
        const API = "https://script.google.com/macros/s/AKfycbxgFs9T6PTLiu8k9qdHJ_UJAwtPMcmzymMGG23_FcN7EPG40DMolYB-wcAVo0WXdCM5/exec";
        // ================================================================

        let localData = {};
        let serverHash = ""; 
        let isTyping = false;
        let typingTimer;
        
        const frames = [document.getElementById('f0'), document.getElementById('f1'), document.getElementById('f2')];
        const statusTxt = document.getElementById('status-text');
        const dot = document.getElementById('dot');

        // 1. KHỞI ĐỘNG: Tải dữ liệu ngay
        window.onload = () => loadData(true);

        function sw(i) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('iframe').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.tab')[i].classList.add('active');
            frames[i].classList.add('active');
        }

        // 2. NHẬN BIẾT NGƯỜI DÙNG ĐANG NHẬP LIỆU
        window.addEventListener('message', e => {
            if(e.data.type && e.data.type.includes('DATA_RETURN')) {
                localData[e.data.app] = e.data.data;
                
                // Khi đang gõ phím -> Chuyển trạng thái sang VÀNG (Đang chờ lưu)
                isTyping = true;
                setStatus('sync', 'Đang nhập...');
                
                // Nếu ngừng gõ 2 giây -> Tự động lưu
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    isTyping = false;
                    saveData();
                }, 2000);
            }
        });

        // 3. HÀM TỰ ĐỘNG LƯU (AUTO SAVE)
        async function saveData() {
            setStatus('sync', 'Đang lưu...');
            try {
                // Gửi dữ liệu đi
                await fetch(API, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(localData)
                });
                // Cập nhật lại mốc so sánh
                serverHash = JSON.stringify(localData);
                setStatus('ok', 'Đã lưu xong');
            } catch(e) {
                console.error(e);
                setStatus('err', 'Lỗi lưu!');
            }
        }

        // 4. HÀM TỰ ĐỘNG TẢI (AUTO LOAD)
        async function loadData(firstTime = false) {
            // Nếu đang gõ phím thì KHÔNG tải về (tránh giật)
            if(isTyping && !firstTime) return;

            try {
                // Thêm ?t=... để chống Cache trình duyệt
                const res = await fetch(API + "?t=" + Date.now());
                const data = await res.json();
                const jsonStr = JSON.stringify(data);

                // Nếu dữ liệu trên mây KHÁC dữ liệu dưới máy -> Cập nhật
                if(jsonStr !== serverHash) {
                    serverHash = jsonStr;
                    localData = data;
                    
                    if(data.app1) frames[0].contentWindow.postMessage({type:'RESTORE_DATA', payload: data.app1}, '*');
                    if(data.app2) frames[1].contentWindow.postMessage({type:'RESTORE_DATA', payload: data.app2}, '*');
                    if(data.app3) frames[2].contentWindow.postMessage({type:'RESTORE_DATA_IDB', payload: data.app3}, '*');
                    
                    console.log("Đã cập nhật dữ liệu mới từ Server");
                }
                
                if(!isTyping) setStatus('ok', 'Sẵn sàng');

                // Tắt màn hình chờ nếu là lần đầu
                if(firstTime) {
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(()=>document.getElementById('loader').style.display='none', 500);
                }

            } catch(e) {
                console.error(e);
                if(firstTime) { 
                    alert("Không thể kết nối dữ liệu! Vui lòng kiểm tra mạng.");
                    document.getElementById('loader').style.display='none';
                }
            }
        }

        // 5. CHU KỲ KIỂM TRA: 10 giây một lần
        setInterval(() => {
            if(!isTyping) loadData();
        }, 10000);

        // Kích hoạt iframe gửi dữ liệu mỗi 5s để cập nhật biến localData
        setInterval(() => {
            frames[0].contentWindow.postMessage({type:'GET_DATA'},'*');
            frames[1].contentWindow.postMessage({type:'GET_DATA'},'*');
            frames[2].contentWindow.postMessage({type:'GET_DATA_IDB'},'*');
        }, 5000);

        function setStatus(cls, txt) {
            dot.className = 'dot ' + cls;
            statusTxt.innerText = txt;
        }
    </script>
</body>
</html>
