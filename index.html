<script>
    // ============================================================
    // LINK API ĐÃ ĐƯỢC CẬP NHẬT
    const API_URL = "https://script.google.com/macros/s/AKfycbxcS9ds-E-PsFVNIrwKoORIEmwd66lYeRuslg73S6B_c-dQX-lXMCTiHA6LOtc0fqtE/exec"; 
    // ============================================================

    const frames = [document.getElementById('f1'), document.getElementById('f2'), document.getElementById('f3')];
    const statusText = document.getElementById('statusText');
    const led = document.getElementById('led');
    let saveTimer;

    // 1. CHUYỂN TAB
    function switchApp(index) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === index));
        frames.forEach((f, i) => f.classList.toggle('active', i === index));
    }

    // 2. KHỞI ĐỘNG: TẢI DỮ LIỆU TỪ MÂY
    window.onload = async () => {
        try {
            await fetch(API_URL, { mode: 'no-cors' });  // Gửi silent, tránh CORS block
            setStatus('ok', 'Sẵn sàng (offline)');
        } catch(e) {
            console.error(e);
            alert("Không thể tải dữ liệu từ máy chủ. Đang sử dụng dữ liệu offline trên máy.");
        }
        // Force tắt loader và reload iframes
        document.getElementById('loader').style.display = 'none';
        frames.forEach(f => f.contentWindow.location.reload());
    };

    // 3. LẮNG NGHE TÍN HIỆU TỪ APP CON
    window.addEventListener('message', (e) => {
        if(e.data.type === 'DATA_RETURN' || e.data.type === 'DATA_RETURN_IDB') {
            const appName = e.data.app;
            const appData = e.data.data;
            
            setStatus('saving', 'Đang chờ lưu...');
            clearTimeout(saveTimer);

            saveTimer = setTimeout(() => {
                syncToCloud(appName, appData);
            }, 2000);
        }
    });

    // 4. GỬI LÊN MÂY
    async function syncToCloud(appName, data) {
        setStatus('syncing', 'Đang đồng bộ...');
        try {
            const payload = {};
            payload[appName] = data;
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',  // Gửi silent, tránh block
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            setStatus('ok', 'Đã lưu mây');
            setTimeout(() => setStatus('ok', 'Sẵn sàng'), 2000);
        } catch(e) {
            console.error(e);
            setStatus('error', 'Lỗi mạng! Dữ liệu lưu local.');
            alert('Lỗi đồng bộ: ' + e.message + '. Dữ liệu vẫn lưu local.');
        }
    }

    function setStatus(state, text) {
        led.className = 'led ' + state;
        statusText.innerText = text;
    }
    
    // 5. ĐỊNH KỲ 10 GIÂY HỎI CÁC APP CON XEM CÓ DỮ LIỆU KHÔNG (Backup)
    setInterval(() => {
         frames[0].contentWindow.postMessage({type:'GET_DATA'}, '*');
         frames[1].contentWindow.postMessage({type:'GET_DATA'}, '*');
         frames[2].contentWindow.postMessage({type:'GET_DATA_IDB'}, '*');
    }, 10000);

</script>
