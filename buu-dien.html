<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QU·∫¢N L√ù VƒÇN B·∫¢N G·ª¨I - THADS KV 14</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. GIAO DI·ªÜN HI·ªÇN TH·ªä (SCREEN UI)
           ========================================= */
        :root {
            --primary: #1e40af;       
            --primary-dark: #1e3a8a; 
            --bg-body: #f1f5f9;       
            --text-main: #000000;
            --border: #cbd5e1;        
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body); margin: 0; padding: 0; color: #334155; font-size: 14px; }

        .app-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white; padding: 15px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px;
        }
        .app-header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        .container { max-width: 1250px; margin: auto; padding: 0 15px 40px 15px; }

        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 20px; }
        .card-body { padding: 25px; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eff6ff; }
        .section-title { font-weight: 800; color: var(--primary-dark); text-transform: uppercase; font-size: 16px; letter-spacing: 0.5px; }
        .section-icon { background: var(--primary-dark); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }

        .form-row { margin-bottom: 20px; }
        .row-3-cols { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; color: var(--text-main); }

        input, textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; font-weight: 500; color: #1e293b; background: #fff; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        /* HI·ªÜU ·ª®NG COPY M√ÄU ƒê·ªé */
        .is-copy { color: #ef4444 !important; border-color: #fca5a5 !important; font-weight: 600; }

        .receiver-list { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc; }
        .receiver-row { display: grid; grid-template-columns: 1fr 120px 40px; gap: 10px; margin-bottom: 10px; }
        
        .btn-add { background: white; border: 1px dashed var(--primary); color: var(--primary); width: 100%; padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }

        .action-area { background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 20px; display: flex; justify-content: center; gap: 15px; }
        .btn { border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 13px; text-transform: uppercase; display: inline-flex; align-items: center; gap: 8px; }
        .btn-post { background: #2563eb; color: white; }
        .btn-direct { background: #059669; color: white; }
        .btn-cancel { background: #64748b; color: white; }

        .search-container { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 10px; border: 1px solid #e2e8f0; }
        #searchInput { border: none; flex: 1; padding: 5px; font-size: 15px; margin: 0; }

        table.main-list { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        table.main-list th { padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; background: #f8fafc; border-bottom: 2px solid #e2e8f0; text-align: left; }
        table.main-list td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
        
        .action-btns { display: flex; gap: 8px; justify-content: center; }
        .btn-icon { width: 34px; height: 34px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--primary); color: white; }

        /* TH√îNG B√ÅO B·∫¢N QUY·ªÄN */
        .app-footer { text-align: center; padding: 30px 0; color: #94a3b8; font-size: 12px; border-top: 1px solid #e2e8f0; margin-top: 50px; }
        .app-footer p { margin: 5px 0; }
        .copyright-tag { font-weight: 600; color: #64748b; text-transform: uppercase; }

        /* =========================================
           2. C·∫§U TR√öC IN (CSS) - GI·ªÆ NGUY√äN 100%
           ========================================= */
        @media print {
            * { font-family: "Times New Roman", Times, serif !important; }
            @page { size: A4; margin: 20mm 15mm 20mm 20mm; }
            body { background: white; padding: 0; font-size: 12pt; }
            .no-print { display: none !important; }
            #printA4Area { display: block !important; padding: 0; }
            .header-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .header-table td { vertical-align: top; text-align: center; font-size: 11pt; color: black; white-space: nowrap; }
            .a4-title { text-align: center; font-weight: bold; font-size: 12pt; margin: 25px 0 15px 0; text-transform: uppercase; }
            table.print-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
            table.print-table th, table.print-table td { border: 1px solid black !important; padding: 8px; font-size: 11pt; color: black; word-wrap: break-word; text-align: justify; }
            .footer-area { margin-top: 30px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .footer-col { width: 48%; text-align: center; }
            .is-direct .barcode-col { display: none !important; }
            #printSenderName { font-weight: bold; margin-top: 60px; font-size: 12pt; }
        }
    </style>
</head>
<body>

<div class="app-header no-print">
    <h1>QU·∫¢N L√ù VƒÇN B·∫¢N G·ª¨I - PH√íNG THADS KV 14 - L√ÇM ƒê·ªíNG</h1>
</div>

<div class="container no-print">
    <div class="card">
        <div class="card-body">
            <div class="section-header">
                <div class="section-icon">1</div>
                <div class="section-title">Th√¥ng tin ng∆∞·ªùi nh·∫≠n</div>
            </div>
            
            <div class="form-row">
                <label>N∆°i nh·∫≠n/Ng∆∞·ªùi nh·∫≠n</label>
                <div class="receiver-list">
                    <div id="receiverContainer">
                        <div class="receiver-row">
                            <input type="text" class="in-name" placeholder="H·ªç t√™n ng∆∞·ªùi nh·∫≠n" oninput="this.classList.remove('is-copy')">
                            <input type="number" class="in-year" placeholder="NƒÉm" style="text-align: center;" oninput="this.classList.remove('is-copy')">
                            <button style="border:none; background:none; cursor:pointer; color:#94a3b8; font-size:18px;" onclick="this.parentElement.remove()">‚úï</button>
                        </div>
                    </div>
                    <button class="btn-add" onclick="addNewReceiver()">+ TH√äM NG∆Ø·ªúI NH·∫¨N</button>
                </div>
            </div>

            <div class="form-row">
                <label>ƒê·ªãa ch·ªâ chi ti·∫øt (N∆°i nh·∫≠n)</label>
                <input type="text" id="inAddr" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, th√¥n/x√≥m, x√£/ph∆∞·ªùng, qu·∫≠n/huy·ªán..." oninput="this.classList.remove('is-copy')">
            </div>

            <div class="section-header" style="margin-top: 35px;">
                <div class="section-icon">2</div>
                <div class="section-title">Chi ti·∫øt VƒÉn b·∫£n & G·ª≠i</div>
            </div>

            <div class="form-row row-3-cols">
                <div><label>S·ªê ƒêI·ªÜN THO·∫†I</label><input type="text" id="inPhone" oninput="this.classList.remove('is-copy')"></div>
                <div><label>M√É V·∫†CH B∆ØU ƒêI·ªÜN</label><input type="text" id="inBarcode" oninput="this.classList.remove('is-copy')"></div>
                <div><label>NG∆Ø·ªúI G·ª¨I (K√ù T√äN)</label><input type="text" id="inSender" style="font-weight: bold; color: #1e40af;"></div>
            </div>

            <div class="form-row">
                <label>N·ªôi dung vƒÉn b·∫£n / Tr√≠ch y·∫øu</label>
                <textarea id="inContent" rows="3" oninput="this.classList.remove('is-copy')"></textarea>
            </div>
        </div>

        <div class="action-area" id="mainActionGroup">
            <button class="btn btn-direct" onclick="saveData('DIRECT')">üë§ L∆∞u G·ª≠i Tr·ª±c Ti·∫øp</button>
            <button class="btn btn-post" onclick="saveData('POST')">üìÆ L∆∞u G·ª≠i B∆∞u ƒêi·ªán</button>
        </div>
        <div class="action-area" id="editActionGroup" style="display: none; background: #fffbeb;">
            <button class="btn btn-cancel" onclick="resetForm()">‚úï H·ªßy S·ª≠a</button>
            <button class="btn btn-direct" onclick="saveData('DIRECT')">üíæ C·∫≠p Nh·∫≠t Tr·ª±c Ti·∫øp</button>
            <button class="btn btn-post" onclick="saveData('POST')">üíæ C·∫≠p Nh·∫≠t B∆∞u ƒêi·ªán</button>
        </div>
        <div class="action-area" id="copyActionGroup" style="display: none; background: #f0fdf4;">
            <button class="btn btn-cancel" onclick="resetForm()">‚úï H·ªßy Copy</button>
            <button class="btn btn-direct" onclick="saveData('DIRECT')">üìã L∆∞u Copy (Tr·ª±c Ti·∫øp)</button>
            <button class="btn btn-post" onclick="saveData('POST')">üìã L∆∞u Copy (B∆∞u ƒêi·ªán)</button>
        </div>
    </div>

    <div class="search-container">
        <span style="font-size: 20px;">üîé</span>
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t√™n, ƒë·ªãa ch·ªâ, n·ªôi dung..." oninput="renderTable()">
        <label style="display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; white-space:nowrap;">
            <input type="checkbox" id="checkShowDate"> Hi·ªán ng√†y
        </label>
        <button class="btn" onclick="printA4()" style="background:#334155; color:white;">IN A4</button>
        <button class="btn" onclick="printTem()" style="background:#059669; color:white;">IN TEM</button>
    </div>

    <table class="main-list">
        <thead>
            <tr>
                <th width="40" style="text-align:center;"><input type="checkbox" id="selectAll" onclick="toggleAll()"></th>
                <th width="100" style="text-align:center;">H√¨nh th·ª©c</th>
                <th>Ng∆∞·ªùi nh·∫≠n & ƒê·ªãa ch·ªâ</th>
                <th>N·ªôi dung</th>
                <th width="130" style="text-align:center;">M√£ v·∫°ch</th>
                <th width="120" style="text-align:center;">Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="dataTableBody"></tbody>
    </table>

    <footer class="app-footer no-print">
        <p class="copyright-tag">TH√îNG B√ÅO B·∫¢N QUY·ªÄN</p>
        <p>·ª®ng d·ª•ng ƒë∆∞·ª£c x√¢y d·ª±ng b·ªüi c√° nh√¢n √¥ng <strong>Mai ƒê·ª©c L√™n</strong>.</p>
        <p>Ch·ªâ ph·ª•c v·ª• m·ª•c ƒë√≠ch s·ª≠ d·ª•ng n·ªôi b·ªô, kh√¥ng th∆∞∆°ng m·∫°i.</p>
    </footer>
</div>

<div id="printA4Area" style="display: none;">
    <table class="header-table">
        <tr>
            <td width="48%">
                <div>THI H√ÄNH √ÅN D√ÇN S·ª∞ T·ªàNH L√ÇM ƒê·ªíNG</div>
                <div style="font-weight: bold;">PH√íNG THI H√ÄNH √ÅN D√ÇN S·ª∞</div>
                <div style="font-weight: bold; text-decoration: underline;">KHU V·ª∞C 14</div>
            </td>
            <td>
                <div style="font-weight: bold;">C·ªòNG HO√Ä X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div>
                <div style="font-weight: bold; text-decoration: underline;">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div>
            </td>
        </tr>
    </table>
    <div class="a4-title" id="a4MainTitle">DANH S√ÅCH G·ª¨I C√îNG VƒÇN...</div>
    <table class="print-table">
        <thead>
            <tr><th width="45">TT</th><th width="220">N∆°i nh·∫≠n/ng∆∞·ªùi nh·∫≠n</th><th>S·ªë c√¥ng vƒÉn...</th><th width="140" class="barcode-col">S·ªë M√£ v·∫°ch</th></tr>
        </thead>
        <tbody id="a4Body"></tbody>
    </table>
    <div class="footer-area">
        <div class="footer-col">
            <div style="height: 30px;"></div><div style="font-weight: bold;" id="footerConfirmLabel">X√ÅC NH·∫¨N C·ª¶A B∆ØU ƒêI·ªÜN</div><div style="font-style: italic;">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="footer-col">
            <div id="footerDate" style="font-style: italic;"></div><div style="font-weight: bold; text-transform: uppercase;">NG∆Ø·ªúI G·ª¨I</div><div style="font-style: italic;">(K√Ω, ghi r√µ h·ªç t√™n)</div><div id="printSenderName"></div>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('thads_v13')) || [];
    let editingId = null;

    function addNewReceiver(n = '', y = '', isRed = false) {
        const div = document.createElement('div');
        div.className = 'receiver-row';
        const cls = isRed ? 'is-copy' : '';
        div.innerHTML = `<input type="text" class="in-name ${cls}" value="${n}" placeholder="H·ªç t√™n" oninput="this.classList.remove('is-copy')">
                         <input type="number" class="in-year ${cls}" value="${y}" style="text-align:center;" placeholder="NƒÉm" oninput="this.classList.remove('is-copy')">
                         <button style="border:none; background:none; cursor:pointer;" onclick="this.parentElement.remove()">‚úï</button>`;
        document.getElementById('receiverContainer').appendChild(div);
    }

    function saveData(type) {
        const names = document.querySelectorAll('.in-name'), years = document.querySelectorAll('.in-year');
        let recs = [];
        names.forEach((n, i) => { if(n.value.trim()) recs.push({name: n.value.trim(), year: years[i].value}) });
        if(recs.length === 0) return alert("Vui l√≤ng nh·∫≠p ng∆∞·ªùi nh·∫≠n!");

        const data = {
            id: editingId || Date.now(), type: type, recs: recs,
            addr: document.getElementById('inAddr').value,
            phone: document.getElementById('inPhone').value,
            content: document.getElementById('inContent').value,
            barcode: document.getElementById('inBarcode').value,
            day: editingId ? db.find(x => x.id === editingId).day : new Date().toLocaleDateString('vi-VN')
        };
        if(editingId) db[db.findIndex(x => x.id === editingId)] = data; else db.push(data);
        localStorage.setItem('thads_v13', JSON.stringify(db));
        localStorage.setItem('thads_last_sender', document.getElementById('inSender').value);
        location.reload();
    }

    function renderTable() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.getElementById('dataTableBody'); tbody.innerHTML = '';
        const filtered = db.filter(i => 
            i.recs.some(r => r.name.toLowerCase().includes(q)) || 
            i.addr.toLowerCase().includes(q) || i.content.toLowerCase().includes(q) || (i.barcode && i.barcode.toLowerCase().includes(q))
        );
        const groups = filtered.reduce((acc, i) => { acc[i.day] = acc[i.day] || []; acc[i.day].push(i); return acc; }, {});
        Object.keys(groups).reverse().forEach(day => {
            tbody.innerHTML += `<tr><td colspan="6"><div style="background:#e0e7ff; color:#3730a3; padding:5px 15px; border-radius:20px; font-weight:700; font-size:12px; margin:15px 0 10px 0; display:inline-block;">üìÖ Ng√†y ${day}</div></td></tr>`;
            groups[day].reverse().forEach(item => {
                const names = item.recs.map(r => `<strong>${r.name}</strong> ${r.year ? '('+r.year+')' : ''}`).join('<br>');
                const badge = item.type === 'POST' ? '<span style="color:#2563eb; font-weight:700;">B∆∞u ƒëi·ªán</span>' : '<span style="color:#16a34a; font-weight:700;">Tr·ª±c ti·∫øp</span>';
                tbody.innerHTML += `
                    <tr>
                        <td align="center"><input type="checkbox" class="row-cb" value="${item.id}"></td>
                        <td align="center">${badge}</td>
                        <td>${names}<br><small style="color:#64748b">üè† ${item.addr}</small></td>
                        <td style="white-space: pre-wrap;">${item.content}</td>
                        <td align="center"><strong style="color:#ef4444;">${item.barcode || '-'}</strong></td>
                        <td class="action-btns">
                            <button class="btn-icon" onclick="editItem(${item.id})">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="makeCopy(${item.id})">üìã</button>
                            <button class="btn-icon" onclick="deleteItem(${item.id})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });
    }

    /* LOGIC IN ·∫§N - GI·ªÆ NGUY√äN */
    function printA4() {
        const ids = Array.from(document.querySelectorAll('.row-cb:checked')).map(c => parseInt(c.value));
        if(ids.length === 0) return alert("Ch·ªçn d√≤ng c·∫ßn in!");
        const selected = db.filter(i => ids.includes(i.id));
        const isDirect = selected.every(i => i.type === 'DIRECT');
        document.getElementById('a4MainTitle').innerText = isDirect ? "DANH S√ÅCH G·ª¨I C√îNG VƒÇN, QUY·∫æT ƒê·ªäNH, TH√îNG B√ÅO..." : "DANH S√ÅCH G·ª¨I C√îNG VƒÇN, QUY·∫æT ƒê·ªäNH, TH√îNG B√ÅO... QUA B∆ØU ƒêI·ªÜN";
        document.getElementById('footerConfirmLabel').innerText = isDirect ? "X√ÅC NH·∫¨N C·ª¶A B√äN NH·∫¨N" : "X√ÅC NH·∫¨N C·ª¶A B∆ØU ƒêI·ªÜN";
        if(isDirect) document.body.classList.add('is-direct'); else document.body.classList.remove('is-direct');
        const now = new Date(), isTick = document.getElementById('checkShowDate').checked;
        document.getElementById('footerDate').innerText = `Li√™n H∆∞∆°ng, ng√†y ${isTick ? now.getDate() : "‚Ä¶."} th√°ng ${now.getMonth()+1} nƒÉm ${now.getFullYear()}`;
        document.getElementById('printSenderName').innerText = document.getElementById('inSender').value;
        let h = ''; selected.forEach((item, i) => {
            const n = item.recs.map(r => `${r.name}${r.year ? ', sinh nƒÉm '+r.year : ''}`).join(' v√† ');
            h += `<tr><td align="center">${i+1}</td><td><strong>${n}</strong><br>ƒê·ªãa ch·ªâ: ${item.addr}</td><td style="white-space: pre-wrap;">${item.content}</td><td align="center" class="barcode-col"><strong>${item.barcode || ''}</strong></td></tr>`;
        });
        document.getElementById('a4Body').innerHTML = h; window.print();
    }

    function printTem() {
        const ids = Array.from(document.querySelectorAll('.row-cb:checked')).map(c => parseInt(c.value));
        if(ids.length === 0) return alert("Ch·ªçn d√≤ng!");
        const selected = db.filter(i => ids.includes(i.id));
        let h = '';
        selected.forEach(item => {
            const names = item.recs.map(r => `<strong style="font-size:11.5px">${r.name}</strong> <span style="font-size:10px; font-weight:normal">${r.year ? '('+r.year+')' : ''}</span>`).join(', ');
            h += `<div style="width:50mm; height:30mm; padding:2mm; box-sizing:border-box; font-family:Arial; line-height:1.1; border:1px solid black; overflow:hidden; page-break-inside:avoid; text-align:justify;">
                    <div style="font-size:10px; margin-bottom:1mm;">Ng∆∞·ªùi nh·∫≠n: ${names}</div>
                    ${item.addr ? '<div style="font-size:10.5px; margin-bottom:1mm;">ƒê/c: '+item.addr+'</div>' : ''}
                    ${item.phone ? '<div style="font-size:10.5px;">SƒêT: '+item.phone+'</div>' : ''}
                  </div>`;
        });
        const w = window.open('', '_blank');
        w.document.write(`<html><head><style>@page { size: 50mm 30mm; margin: 0; } body { margin: 0; padding: 0; }</style></head><body>${h}
        <script>window.onload = function() { window.print(); setTimeout(function() { window.close(); }, 500); };<\/script></body></html>`);
        w.document.close();
    }

    function editItem(id) {
        const item = db.find(x => x.id === id); editingId = id;
        document.getElementById('receiverContainer').innerHTML = '';
        item.recs.forEach(r => addNewReceiver(r.name, r.year));
        ['inAddr', 'inPhone', 'inContent', 'inBarcode'].forEach(fid => {
            document.getElementById(fid).value = item[fid.replace('in','').toLowerCase()] || '';
        });
        showActions('EDIT'); window.scrollTo(0,0);
    }

    function makeCopy(id) {
        const item = db.find(x => x.id === id); editingId = null;
        document.getElementById('receiverContainer').innerHTML = '';
        item.recs.forEach(r => addNewReceiver(r.name, r.year, true));
        ['inAddr', 'inPhone', 'inContent', 'inBarcode'].forEach(fid => {
            const el = document.getElementById(fid);
            el.value = item[fid.replace('in','').toLowerCase()] || '';
            el.classList.add('is-copy');
        });
        showActions('COPY'); window.scrollTo(0,0);
    }

    function showActions(mode) {
        document.getElementById('mainActionGroup').style.display = 'none';
        document.getElementById('editActionGroup').style.display = mode === 'EDIT' ? 'flex' : 'none';
        document.getElementById('copyActionGroup').style.display = mode === 'COPY' ? 'flex' : 'none';
    }

    function resetForm() { location.reload(); }
    function deleteItem(id) { if(confirm("X√≥a d√≤ng n√†y?")) { db = db.filter(i => i.id !== id); localStorage.setItem('thads_v13', JSON.stringify(db)); renderTable(); } }
    function toggleAll() { const s = document.getElementById('selectAll').checked; document.querySelectorAll('.row-cb').forEach(c => c.checked = s); }
    window.onload = () => { renderTable(); document.getElementById('inSender').value = localStorage.getItem('thads_last_sender') || ''; };
</script>
<script>
window.addEventListener('message', function(e) {
    if (e.data.type === 'GET_DATA') {
        // Ch·ªâ l·∫•y key 'thads_v13' theo ƒë√∫ng logic app n√†y
        const val = localStorage.getItem('thads_v13');
        const data = val ? {'thads_v13': val} : {};
        window.parent.postMessage({type: 'DATA_RETURN', app: 'app2', data: data}, '*');
    }
    if (e.data.type === 'RESTORE_DATA') {
        const d = e.data.payload;
        if(d && d.thads_v13) { localStorage.setItem('thads_v13', d.thads_v13); location.reload(); }
    }
});
</script>
</body>
</html>